{% extends 'base.html' %}

{%block head%}
<script type="text/javascript">
function calc_total(){
    count = $('.cart_list_td').length
    $('.total_count em').text(count);
    $('.settlements .col03 b').text(count);
    total=0
    $('.cart_list_td').each(function(){
        price=parseFloat($(this).children('.col05').children('em').text());
        count=parseInt($(this).find('.num_show').val());
        total1=price*count;
        $(this).children('.col07').text(total1.toFixed(2)+'元');
        if($(this).children('.col01').children('input').prop('checked')){
            total+=total1;
        }
    })
    $('.settlements .col03 em').text(total.toFixed(2))
}

function del(carts_id) {
    if(confirm('确定要删除吗？')){
        $.get('/cart/delete/',{'id':carts_id},function (data) {
            if(data.result=='ok'){
                $('#'+carts_id).remove();
                calc_total();
            }
        });
    }
}

$(function(){
	calc_total();
	$('#check_all').change(function(){
		$(':checkbox:not(#check_all)').prop('checked',$(this).prop('checked'))
		calc_total();
	});

	$(':checkbox:not(#check_all)').change(function(){
	    calc_total();
	    if($(':checkbox:not(#check_all)').length == $(':checked:not(#check_all)').length){
	        $('#check_all').prop('checked',true)
	    }else{
	        $('#check_all').prop('checked',false)
	    };
	});


	$('.add').click(function(){
	    count=parseInt($(this).next().val());
	    count+=1
        $(this).next().val(count).blur()
	})


	$('.minus').click(function(){
        count=parseInt($(this).prev().val())
	    count-=1
	    $(this).prev().val(count).blur()
	})

	$('.num_show').blur(function(){
	    count=parseInt($(this).val());
        //判断库存
	    kucun=parseInt($(this).parents('.col06').prevAll('.col03').children('em').text());
	    if(count >= kucun){
	        count = kucun;
	    }
	    if(count<=1){
	        count=1
	    }

	    id=$(this).parents('.col06').prevAll('input').val()
	    $me=$(this)
        $.get('/cart/count_change/',{'id':id,'count':count},function (data) {
            $me.val(data.count);
            calc_total();
        });

	})

});


</script>
{%endblock head%}
{%block content%}
	<div class="total_count">全部商品<em>2</em>件</div>
	<ul class="cart_list_th clearfix">
		<li class="col01">商品名称</li>
		<li class="col02">商品单位</li>
		<li class="col03">商品价格</li>
		<li class="col04">数量</li>
		<li class="col05">小计</li>
		<li class="col06">操作</li>
	</ul>

<form method="get" action="/order/">
{%for carts in cart_list%}
	<ul class="cart_list_td clearfix" id="{{carts.id}}">
        <input type="hidden" value="{{carts.id}}">
		<li class="col01"><input type="checkbox" name="carts_id" value="{{carts.id}}" checked="checked"></li>
		<li class="col02"><img src="/static/{{carts.goods.tpic}}"></li>
        <li class="col03">{{carts.goods.title}}<br><em>{{carts.goods.gkuncun}}</em></li>
		<li class="col04">{{carts.goods.gunit}}</li>
        <li class="col05"><em>{{carts.goods.tprice}}</em>元</li>
		<li class="col06">
			<div class="num_add">
				<a href="javascript:;" class="add fl">+</a>
				<input type="text" class="num_show fl" value="{{carts.count}}">
				<a href="javascript:;" class="minus fl">-</a>
			</div>
		</li>
		<li class="col07"></li>
		<li class="col08"><a href="javascript:del({{carts.id}})">删除</a></li>
	</ul>
{%empty%}
没有购物
{%endfor%}

	<ul class="settlements">
		<li class="col01"><input type="checkbox" name="" checked="checked" id="check_all"></li>
		<li class="col02">全选</li>
		<li class="col03">合计(不含运费)：<span>¥</span><em>42.60</em><br>共计<b>2</b>件商品</li>
        <li class="col04"><input type="submit" value="去结算"></input></li>
	</ul>
</form>
{%endblock content%}